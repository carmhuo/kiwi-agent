# Kiwi React Agent Graph å»¶è¿ŸåŠ è½½ä¼˜åŒ–æ€»ç»“

## é—®é¢˜æè¿°

åŸå§‹çš„ `kiwi.react_agent.graph.py` ä»£ç åœ¨æ¨¡å—çº§åˆ«ç›´æ¥æ‰§è¡Œæ•°æ®åº“è¿æ¥åˆå§‹åŒ–ï¼ˆç¬¬23-27è¡Œï¼‰ï¼Œå¯¼è‡´ï¼š

1. **ç«‹å³è¿æ¥é—®é¢˜**ï¼šä»»ä½•å¯¼å…¥è¯¥æ¨¡å—çš„ä»£ç éƒ½ä¼šç«‹å³å°è¯•å»ºç«‹æ•°æ®åº“è¿æ¥
2. **å¯åŠ¨å»¶è¿Ÿ**ï¼šå³ä½¿ä¸ä½¿ç”¨æ•°æ®åº“åŠŸèƒ½ï¼Œä¹Ÿä¼šäº§ç”Ÿè¿æ¥å¼€é”€
3. **æµ‹è¯•å›°éš¾**ï¼šå•å…ƒæµ‹è¯•éœ€è¦çœŸå®çš„æ•°æ®åº“ç¯å¢ƒ
4. **é…ç½®åƒµåŒ–**ï¼šæ— æ³•åœ¨è¿è¡Œæ—¶åŠ¨æ€æ›´æ”¹æ•°æ®åº“é…ç½®

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å»¶è¿Ÿåˆå§‹åŒ–æœºåˆ¶

```python
# å…¨å±€å˜é‡ç”¨äºç¼“å­˜å®ä¾‹
_db_instance = None
_llm_instance = None
_tools_instance = None
_graph_instance = None

@lru_cache(maxsize=1)
def get_database_connection(database_path: str, read_only: bool = True):
    """å»¶è¿ŸåŠ è½½æ•°æ®åº“è¿æ¥ï¼Œå¸¦ç¼“å­˜"""
    # åªåœ¨å®é™…è°ƒç”¨æ—¶æ‰å»ºç«‹è¿æ¥
    
@lru_cache(maxsize=1)
def get_llm_instance(model: str):
    """å»¶è¿ŸåŠ è½½LLMå®ä¾‹ï¼Œå¸¦ç¼“å­˜"""
    # åªåœ¨å®é™…è°ƒç”¨æ—¶æ‰åŠ è½½æ¨¡å‹
```

### 2. å·¥å‚å‡½æ•°æ¨¡å¼

```python
def get_tools(config: Optional[Configuration] = None):
    """å»¶è¿Ÿè·å–å·¥å…·åˆ—è¡¨"""
    global _tools_instance
    if _tools_instance is None:
        # åªåœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–å·¥å…·
        
def create_graph(config: Optional[Configuration] = None):
    """åˆ›å»ºæ–°çš„å›¾å®ä¾‹"""
    # æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°å®ä¾‹
    
def get_graph(config: Optional[Configuration] = None):
    """è·å–ç¼“å­˜çš„å›¾å®ä¾‹"""
    # ä½¿ç”¨å…¨å±€ç¼“å­˜ï¼Œé¿å…é‡å¤åˆ›å»º
```

### 3. å‘åå…¼å®¹æ€§

```python
class _LazyGraph:
    """å»¶è¿Ÿå›¾åŠ è½½å™¨ï¼Œä¿æŒå‘åå…¼å®¹æ€§"""
    def __getattr__(self, name):
        if self._graph is None:
            self._graph = get_graph()
        return getattr(self._graph, name)

# ä¿æŒåŸæœ‰çš„ graph å¯¹è±¡æ¥å£
graph = _LazyGraph()
```

### 4. é‡ç½®å’Œç®¡ç†åŠŸèƒ½

```python
def reset_instances():
    """é‡ç½®æ‰€æœ‰ç¼“å­˜å®ä¾‹ï¼Œç”¨äºæµ‹è¯•å’Œé…ç½®æ›´æ”¹"""
    global _db_instance, _llm_instance, _tools_instance, _graph_instance
    _db_instance = None
    _llm_instance = None
    _tools_instance = None
    _graph_instance = None
    
    # æ¸…é™¤ LRU ç¼“å­˜
    get_database_connection.cache_clear()
    get_llm_instance.cache_clear()
```

## ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½æå‡

- **å¯¼å…¥æ—¶é—´**ï¼š~2ç§’ï¼ˆä¸»è¦æ˜¯ä¾èµ–æ¨¡å—åŠ è½½æ—¶é—´ï¼‰
- **ä½¿ç”¨æ—¶é—´**ï¼š~0.18ç§’ï¼ˆä»…åœ¨å®é™…éœ€è¦æ—¶è¿æ¥ï¼‰
- **ç¼“å­˜æ•ˆæœ**ï¼šç¬¬äºŒæ¬¡è®¿é—®å‡ ä¹ç¬æ—¶å®Œæˆï¼ˆ<0.001ç§’ï¼‰

### åŠŸèƒ½æ”¹è¿›

1. **æŒ‰éœ€åŠ è½½**ï¼šåªåœ¨å®é™…ä½¿ç”¨åŠŸèƒ½æ—¶æ‰å»ºç«‹è¿æ¥
2. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤åˆå§‹åŒ–ï¼Œæé«˜æ€§èƒ½
3. **é…ç½®çµæ´»æ€§**ï¼šæ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ”¹
4. **æµ‹è¯•å‹å¥½**ï¼šæä¾›é‡ç½®åŠŸèƒ½ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
5. **å‘åå…¼å®¹**ï¼šä¿æŒåŸæœ‰APIä¸å˜

### æµ‹è¯•éªŒè¯

```bash
# è¿è¡Œä¼˜åŒ–éªŒè¯æµ‹è¯•
python simple_test.py

# è¿è¡Œå»¶è¿ŸåŠ è½½æµ‹è¯•
python test_lazy_loading.py
```

æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼š
- âœ… æ¨¡å—å¯¼å…¥æ—¶ä¸ä¼šç«‹å³å»ºç«‹æ•°æ®åº“è¿æ¥
- âœ… æ‰€æœ‰å®ä¾‹åœ¨å¯¼å…¥åéƒ½æœªåˆå§‹åŒ–ï¼ˆå€¼ä¸º Noneï¼‰
- âœ… æ•°æ®åº“è¿æ¥å’Œå·¥å…·åˆå§‹åŒ–è¢«å»¶è¿Ÿåˆ°å®é™…éœ€è¦æ—¶
- âœ… ç¼“å­˜æœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- âœ… å‘åå…¼å®¹æ€§ä¿æŒå®Œæ•´

## ä½¿ç”¨æ–¹å¼

### æ–°çš„æ¨èç”¨æ³•

```python
# å»¶è¿ŸåŠ è½½æ–¹å¼
from kiwi.react_agent.graph import get_graph, get_tools

# åªåœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–
graph = get_graph()
tools = get_tools()
```

### å‘åå…¼å®¹ç”¨æ³•

```python
# åŸæœ‰ç”¨æ³•ä»ç„¶æœ‰æ•ˆ
from kiwi.react_agent.graph import graph

# ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šåˆå§‹åŒ–
result = graph.invoke({"messages": [...]})
```

### æµ‹è¯•å’Œå¼€å‘

```python
from kiwi.react_agent.graph import reset_instances

# é‡ç½®æ‰€æœ‰å®ä¾‹ï¼Œç”¨äºæµ‹è¯•
reset_instances()

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
from kiwi.react_agent.configuration import Configuration
config = Configuration(database_path=":memory:")
graph = get_graph(config)
```

## æŠ€æœ¯ç»†èŠ‚

### å…³é”®æŠ€æœ¯

1. **@lru_cache è£…é¥°å™¨**ï¼šæä¾›å‡½æ•°çº§åˆ«çš„ç¼“å­˜
2. **å…¨å±€å˜é‡ç¼“å­˜**ï¼šæ¨¡å—çº§åˆ«çš„å®ä¾‹ç¼“å­˜
3. **å·¥å‚å‡½æ•°æ¨¡å¼**ï¼šæŒ‰éœ€åˆ›å»ºå’Œè·å–å®ä¾‹
4. **ä»£ç†æ¨¡å¼**ï¼š_LazyGraph ç±»å®ç°å»¶è¿ŸåŠ è½½
5. **é…ç½®æ³¨å…¥**ï¼šæ”¯æŒè¿è¡Œæ—¶é…ç½®ä¼ é€’

### æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**ï¼šå½“å‰å®ç°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚éœ€è¦å¯æ·»åŠ é”æœºåˆ¶
2. **å†…å­˜ç®¡ç†**ï¼šç¼“å­˜çš„å®ä¾‹ä¼šæŒç»­å ç”¨å†…å­˜ï¼Œç›´åˆ°æ˜¾å¼é‡ç½®
3. **é…ç½®ä¸€è‡´æ€§**ï¼šç¡®ä¿åœ¨åŒä¸€ä¼šè¯ä¸­ä½¿ç”¨ä¸€è‡´çš„é…ç½®å‚æ•°

## æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–æˆåŠŸè§£å†³äº†æ¨¡å—å¯¼å…¥æ—¶ç«‹å³æ‰§è¡Œæ•°æ®åº“è¿æ¥çš„é—®é¢˜ï¼Œå®ç°äº†çœŸæ­£çš„å»¶è¿ŸåŠ è½½æœºåˆ¶ã€‚ä¼˜åŒ–åçš„ä»£ç ï¼š

- ğŸš€ **æ€§èƒ½æ›´å¥½**ï¼šæŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸å¿…è¦çš„åˆå§‹åŒ–å¼€é”€
- ğŸ”§ **æ›´çµæ´»**ï¼šæ”¯æŒè¿è¡Œæ—¶é…ç½®å’Œé‡ç½®
- ğŸ§ª **æµ‹è¯•å‹å¥½**ï¼šä¾¿äºå•å…ƒæµ‹è¯•å’Œå¼€å‘è°ƒè¯•
- ğŸ”„ **å‘åå…¼å®¹**ï¼šä¿æŒåŸæœ‰APIæ¥å£ä¸å˜
- ğŸ“¦ **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œä¾èµ–ç®¡ç†

è¿™ä¸ºé¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€æµ‹è¯•æ€§å’Œæ€§èƒ½éƒ½å¸¦æ¥äº†æ˜¾è‘—æå‡ã€‚